<html>
    <head>
        <title>Main Page</title>
        <link rel="stylesheet" href="styles.css">
        <script type="text/javascript" src = "https://rawgit.com/schmich/instascan-builds/master/instascan.min.js"></script>
        <script type="text/javascript" src = "https://cdnjs.cloudflare.com/ajax/libs/webrtc-adapter/3.3.3/adapter.min.js"></script>
    	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.1.10/vue.min.js"></script>
        <!--<script src="https://myskypower.net/components/modal/modal.js" defer></script>-->

    </head>
    <body>
        <!--<p>This is the main page.</p>-->
        <!--<button id="signout_button" onclick="handleSignoutClick()">Sign Out</button>-->
        <!--<button id="create_button" onclick="func1()">Read Spreadsheet</button>-->
        <!--<h3>Update Instrument Information</h3>-->
        <!--<label for="instrument">Change Value For <span id="field1"></span></label>-->
        <!--<input type="text" id="instrument" name="instrument" placeholder="Instrument"><br>-->
        <!--<label for="student">Change Value For <span id="field2"></span></label>-->
        <!--<input type="text" id="student" name="student" placeholder="Student Name"><br>-->
        <button id="test" onclick="handleAuthClick()">Test</button>
        <button id="stopCam">Turn off cam</button>

        <div class="webcam">
            <video id="preview" width="100%"></video>
        </div>

        <div class="box">
            <br><a href = "#modify" class = "button" id="get_button">Pop Up</a>
            
        </div>


        <div class="overlay" id = "modify">
            <div class="wrapper">
                <h2>Update Instrument<br>Information</h2>
                <br><h3 id="ins_name"></h3>
                <a href="#" class="close" onclick="makeTrue()">&times;</a>
                <div class="content">
                    <div class="container">
                        <form>
                            <div class="text">
                                <input type="text" id="student" name="student" class="effect" placeholder="Student Name" autocomplete="off">
                                <span class="focus-border"></span>
                            </div>
                            <div class="text">
                                <input type="text" id="grade" name="grade" class="effect" placeholder="Student Grade" autocomplete="off">
                                <span class="focus-border"></span>
                            </div>
                            <br><a id="submit_button" class = "button" onclick="setValues()">Submit</a>
                            <label id= "verify">Field(s) are empty. <a onclick = "func2()" class="continue">Continue</a>?</label>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <div id="mySidebar" class="sidebar">
            <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
            <a href="#">Scan</a>
            <a href="edit.html">Sheets</a>
            <a href="#account">Account</a>
            <a href="#home">About</a>
          </div>
          
          <div id="main">
            <a class="openbtn" onclick="openNav()">&#9776;</a>
          </div>

        <pre id="content" style="white-space: pre-wrap;"></pre>
        <script type="text/javascript" src = "signin.js"></script>
        <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
        <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
        <script async defer src="https://apis.google.com/js/api.js"></script>

        <script>
            let getbtn = document.getElementById("get_button");
            let setbtn = document.getElementById("submit_button");

            let scanner = new Instascan.Scanner({video: document.getElementById('preview')});
                Instascan.Camera.getCameras().then(function(cameras){
                if(cameras.length > 0){
                    console.log("camera")
                    scanner.start(cameras[0]);
                }else{
                    modal.style.display = "block";
                    modalText.innerHTML = `No cameras found`;
                }
                }).catch(function(e){
                console.error(e);
                });
            
            stopCam.addEventListener("click", ()=> {
                Instascan.Camera.getCameras().then(function(cameras){
                    if(cameras.length > 0){
                        scanner.stop(cameras[0]);
                    }else{
                        modal.style.display = "block";
                        modalText.innerHTML = `No cameras found`;
                    }
                }).catch(function(e){
                    console.error(e);
                });
            })

            var parameters;
            var sheetId;
            var index = 3;
            var ranges;
            var setRanges;

            
            scanner.addListener('scan', function(c){
                //document.getElementById('text').value=c;
                document.getElementById('get_button').style.visibility= 'visible';
                console.log('yes');
                console.log(c);
                

                parameters = c.split(",");
                sheetId = parameters[1];
                //response.result.valueRanges[0].values
                console.log("index: " + `${findRow(parameters[0], sheetId)}`)
                findRow(parameters[0], sheetId)
                console.log(ranges)
            });

            getbtn.addEventListener("click", ()=> {
                console.log(ranges)
                console.log(sheetId)
                getValues(sheetId, ranges);
            });

            setbtn.addEventListener("click", ()=> {
                /*let v1 = document.getElementById("student").placeholder;
                let v2 = document.getElementById("grade").placeholder;
                if (document.getElementById("student").value != '') {
                    v1 = document.getElementById("student").value;
                }
                if (document.getElementById("grade").value != '') {
                    v2 = document.getElementById("grade").value;
                }
                */
                let v = [[document.getElementById("student").value, document.getElementById("grade").value]];
                console.log(document.getElementById("student").value)
                setValues(v, setRanges, sheetId);
                document.getElementById('student').value = "";
            document.getElementById('grade').value = "";
            });

            
            function findRow(insId, sheetId) {
                var params = {
                    spreadsheetId: sheetId,
                    ranges: ["Sheet1!E:E"],
                    valueRenderOption: 'FORMATTED_VALUE',
                    dateTimeRenderOption: 'SERIAL_NUMBER',
                };
                var request = gapi.client.sheets.spreadsheets.values.batchGet(params);
                request.then(function(response) {
                    console.log(response.result.valueRanges[0].values);
                    values = `${response.result.valueRanges[0].values}`.split(",");
                    this.index = values.indexOf(insId) + 1;
                    console.log(this.index);
                    ranges = "Sheet1!B" + index + ":D" + index;
                    setRanges = "Sheet1!C" + index + ":D" + index;
                    //return num;
                }, function(reason) {
                    console.error('error: ' + reason.result.error.message);
                });
                //return num;
            }
        </script>
    </body>
</html>


